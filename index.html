<!DOCTYPE html>
<html>
  <head>
    <title>Assignment Two</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <!--[if lte IE 8]>
      <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
    <![endif]-->

    <link rel="stylesheet" href="styles.css">    
  </head>
  <body>
    
    <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Move Right</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="index.html"><span class="glyphicon glyphicon-home"></span> Home</a></li>
            <li><a href="about.html"><span class="glyphicon glyphicon-info-sign"></span> About</a></li>
          </ul>
        </div>
      </div>
    <div id="map"></div>

    <!-- include google maps lib -->
    <script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <!-- include cartodb.js library -->
    <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
      <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>

    <script>
      // google.setOnLoadCallback(draw_chart);

        var INFOWINDOW_TEMPLATE = [
          '<div class="lsoa"><p class="muted lsoa-title">{{lookup_wd1}}</p></div>',
          ' <div class="cartodb-tooltip-content-wrapper">',
          '<p class="muted">About the neighbourhood</p>IMD Score: <span class="pull-right">{{imd_score}}</span>',
          '<div id="chart_div"><div class="spacer"></div>',
          '<p class="muted">Avg. sold price<span class="pull-right">Houses sold (2015)</span></p>Â£{{md_2015_fo}}<span class="pull-right">{{fr_2015}}</span>',
          '<p class="muted">Total properties<span class="pull-right">Predominant build period</span> </p>{{voaage_all}}<span class="pull-right">{{voaage_m_1}} (<i>{{percent_ma}}</i>%)</span><div class="spacer"></div>',
          '<p class="muted">Amenities: average distance</p>Nearest school: <span class="pull-right">{{dists_scho}} metres</span><p>Nearest train station:    <span class="pull-right">{{dists_rail}} metres</span></p></div>',
          '<div class="spacer"></div>',
          '<p class="muted">Total pop.<span class="pull-right">JSA Claimants</span></p>',
          '{{voaage_all}}<span class="pull-right">{{claimant_1}}</span>',          
          '<div class="spacer"></div>',
          '<p class="muted">Social media activity</p></div><div id="chart_div">',
          '<script></scr' + 'ipt>',
          '</div>'
        ].join('');

              google.load('visualization', '1.0', {'packages':['corechart']});


      function draw_chart() {
        var data = google.visualization.arrayToDataTable([
          ['', 'population'],
          ['max',  33],
          ['min',  33]
        ]);

        var options = {
          title: ' population',
          legend: { position: "none" },
          width: 300,
        };
        var chart = new google.visualization.ColumnChart(document.getElementById("chart_div"));
        chart.draw(data, options);
      }

      var base = 'https://samcomber.carto.com/api/v2/sql?format=GeoJSON&q=SELECT * FROM imdz_2 WHERE cartodb_id =';
      var layerGroup = new L.LayerGroup();
      var currentHover,
          newFeature = null;

     function main() {

        var map = L.map('map', { 
          center: [53.40, -2.89],
          zoom: 12,
          zoomControl: true
        });

        L.tileLayer('https://maps.nlp.nokia.com/maptiler/v2/maptile/newest/normal.day.grey/{z}/{x}/{y}/256/png8?lg=eng&token=61YWYROufLu_f8ylE0vn0Q&app_id=qIWDkliFCtLntLma2e6O', {
          attribution: 'Nokia'
        }).addTo(map);

        cartodb.createLayer(map, 'http://samcomber.cartodb.com/u/samcomber/api/v2/viz/9d8f5308-0912-11e7-abc6-0e98b61680bf/viz.json')
          .addTo(map)
          .on('done', function(layer) {
            console.log(layer)

            layer.getSubLayer(0).setInteraction(true);
            layer.on('featureOver', function(ev, pos, latlng, data) {
              // console.log("featureover")

              if (data.cartodb_id != currentHover) {
                layerGroup.clearLayers();

                // ajax call to get json with SELECT WHERE query
                $.getJSON(base + data.cartodb_id, function(res) {

                  newFeature = L.geoJson(res, {
                    style: {
                      "color": "#fff",
                      "weight": 2,
                      "opacity": 1                   
                    }
                  });
                  layerGroup.addLayer(newFeature);
                  layerGroup.addTo(map);

                })  
                currentHover = data.cartodb_id;              
              }
            }).on('featureOut', function() {
              // console.log('featureout')
              layerGroup.clearLayers();
            })

              // add custom hoverable infowindow
              cartodb.vis.Vis.addInfowindow(map, layer.getSubLayer(0), ['cartodb_id', 'percent_ma','lookup_wd1','lsoa11cd', 'imd_score', 'md_2015_fo', 'fr_2015', 'dists_scho', 'voaage_m_1', 'grp_nm', 'voaage_all', 'claimant_1', 'dists_rail']); 
              layer.setInteraction(true);
              var sublayer = layer.getSubLayer(0);

              layer.leafletMap.viz.addOverlay({
                   type: 'infobox',
                   layer: sublayer,
                   template: INFOWINDOW_TEMPLATE, 
                   position: 'top|right',
                   fields: [{ lsoa11cd: 'lsoa11cd' }]
              });

              // build custom density legend
              var legend = new cdb.geo.ui.Legend.Density({
                title: "IMD Score",
                left: "0", right: "100", colors: [ "#58A062", "#F07971", "#54BFDE", "#9BC562", "#FABB5C" ]
              });
              // append to map and render
              $('#map').append(legend.render().el);

            }).on('error', function() {
              console.log("some error occurred");
            });
      }


      window.onload = main;
    </script>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  </body>
</html>


